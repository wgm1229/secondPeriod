# 20201223---day

### 登录调用接口跳转到 admin 首页

1.创建 api 目录,封装 ajax

封装reqLogin获取数据方法
ajax.js
```
import axios from 'axios'  //引入axios

export default function ajax(url, data = {}, type = 'GET') {
  if (type === 'GET') {
    return axios.get(url, {  // 这个返回值是一个promise对象
      params: data
    })
  } else {
    return axios.post(url, data)
  }
}
```
api/index.js
```
import ajax from './ajax'
// 登录接口
export const reqLogin = (username, password) => ajax('/login', { username, password }, 'POST')
```
2.storeUtils--Local Storage创建 删除 获取方法
使用Local Storage或cookie存储登录数据
```
//js-cookie yarn add js-cookie
//store yarn add store

npm i store
```
```
import store from 'store'

const USER_KEY = 'user_key' //定义一个常量
export default {
  saveUser(user) {  //存储user
    // localStorage.setItem(USER_KEY,JSON.stringify(user))
    // JSON.parse(localStorage.getItem(USER_KEY))
    store.set(USER_KEY, user)
  },
  getUser() {
    return store.get(USER_KEY) || {} //容错
  },
  removeUser() {
    store.remove(USER_KEY)
  }
}
```
3.login.js引入api方法，并使用axios获取数据
返回 promise 对象的时候你才可以使用 async 和 await 组合进行使用
```
import StoreUtils from "../../utils/storeUtils";
import { reqLogin } from "../../api";

this.props.form.validateFields(async (err, values) => {
if (!err) {
  //表示验证通过
  console.log("Received values of form: ", values);
  const { username, password } = values;
  const result = await reqLogin(username, password);
  if (result.data.status === 0) {
    // 登陆成功提示
    message.success("登陆成功", 1);
    const user = result.data.data;
    StoreUtils.saveUser(user);
    // 如果接口请求成功页面跳转
    this.props.history.replace("/"); 
  }
}
```
this.props.history.replace("/");--跳转到/页面且不能返回上一个页面

## admin页面
1.antd--Layout布局
注意：height:100%没有生效，需要给根节点#root设置height:100%

2.StoreUtils获取用户登录数据
```
import StoreUtils from "../../utils/storeUtils";

const user = StoreUtils.getUser(); //这里是有的，如果你没有登录，根本进不来
<span>欢迎{user.username}</span>&nbsp;&nbsp;&nbsp;    
```

3.退出登录弹框
3.1删除Local Storage的数据
```
// 点击确定
handleOk = () => {
  // 清空localstorage
  StoreUtils.removeUser();
  // 关闭弹框
  this.setState({
    visible: 0,
  });
  // 跳转到登陆页面
  this.props.history.push("/login"); //需要将此组件设置为withRouter组件
};
```
3.2设置为withRouter组件
```
import { withRouter } from "react-router-dom";
export default withRouter(Header);
```
4.当前时间
4.1封装获取时间函数
```
export function formateDate(time) {
  if (!time) return ''
  let date = new Date(time)
  return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds()
}
```
4.2Admin组件引入
```
import { formateDate } from "../../utils/dateUtils";

this.state = {
  visible: 0, //控制弹框的显示和隐藏
  currentTime: formateDate(Date.now()),
};
getTime = () => {// 处理时间
this.intervalId = setInterval(() => {
  const currentTime = formateDate(Date.now());
  this.setState({
    currentTime,
  });
}, 1000);
};
// 生命周期componentDidMount
componentDidMount() {
  // 获取当前的时间
  this.getTime();
}

<span onClick={this.loginout}>退出登录</span>
```